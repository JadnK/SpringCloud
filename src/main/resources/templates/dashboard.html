<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpringCloud Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/settings.css}">
    <script th:src="@{/js/navbar.js}"></script>
</head>
<body class="bg-[var(--color-bg)] text-[var(--color-text)] font-sans min-h-screen">

<!-- Navbar -->
<nav class="fixed top-0 z-50 w-full flex justify-between items-center flex-wrap
            bg-gradient-to-r from-[var(--color-bg)] to-[var(--color-bg-alt)]
            px-8 py-3 shadow-lg border-b-4 border-[var(--color-primary)] font-sans">

    <div class="text-2xl md:text-xl sm:text-lg font-extrabold uppercase tracking-wide
              text-[var(--color-primary)] select-none">SpringCloud</div>

    <button id="burger" class="flex flex-col justify-between w-6 h-5 ml-auto md:hidden">
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
    </button>

    <div id="username-box"
         class="relative hidden md:flex items-center gap-2 bg-[var(--color-bg-alt)] px-5 py-2 rounded-full cursor-pointer transition duration-300 shadow-md">

        <svg class="w-6 h-6 flex-shrink-0 drop-shadow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#b259ff">
            <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.2c-3.2 0-9.5 1.6-9.5 4.9v2.7h19v-2.7c0-3.3-6.3-4.9-9.5-4.9z"/>
        </svg>
        <span th:text="${username}" class="text-white font-semibold">N/A</span>

        <!-- Dropdown -->
        <div id="logoutDropdown"
             class="absolute top-full right-0 mt-3 w-56 bg-[var(--color-bg-alt)] rounded-xl shadow-xl opacity-0 pointer-events-none transform -translate-y-2 transition-all duration-300">
            <div class="flex flex-col py-2">
                <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/admin}"
                   class="px-5 py-3 text-[var(--color-primary)] font-bold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Admin</a>
                <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
                   class="px-5 py-3 text-[var(--color-primary)] font-bold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Add Users</a>
                <a th:href="@{/calendar}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Calendar</a>
                <a th:href="@{/settings}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Settings</a>
                <a th:href="@{/logout}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Logout</a>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden flex-col bg-[var(--color-bg-alt)] rounded-xl mt-4 p-4 gap-3 w-full md:hidden">
        <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/admin}"
           class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Admin</a>
        <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
           class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Add Users</a>
        <a th:href="@{/calendar}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Calendar</a>
        <a th:href="@{/settings}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Settings</a>
        <a th:href="@{/logout}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Logout</a>
    </div>
</nav>

<!-- Content -->
<div class="content px-6 py-8 max-w-[75rem] mx-auto flex flex-col gap-12">

    <!-- Search -->
    <div class="flex justify-end mb-4">
        <input type="text" id="fileSearch" placeholder="Search files..." class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full md:w-1/3" oninput="filterFiles()">
    </div>

    <!-- File List -->
    <ul class="flex flex-col gap-3" id="fileList">
        <li th:each="file : ${files}" class="bg-[var(--color-bg-alt)] p-4 rounded-xl shadow flex justify-between items-center hover:bg-[var(--color-container-hover)] transition">
            <div class="flex flex-col md:flex-row md:gap-4">
                <span th:text="${file.fileName}" class="font-semibold">File Name</span>
                <span th:text="${file.fileType}" class="text-sm text-[var(--color-text-light)]">File Type</span>
                <span th:text="${file.fileOwner.username}" class="text-sm text-[var(--color-text-light)]">Uploader</span>
                <span th:text="${#temporals.format(file.uploadTime, 'dd.MM.yyyy HH:mm')}" class="text-sm text-[var(--color-text-light)]">Upload Date</span>
            </div>
            <div class="flex gap-2">
                <a th:if="${file.fileOwner.username == username}" href="#" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition" th:onclick="confirmShare([[${file.id}]])">Share</a>
                <a th:href="@{'/download/' + ${file.id}}" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition">Download</a>
                <a href="#" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition" th:onclick="showPreviewPopup([[${file.id}]], [[${file.fileType}]], [[${file.fileName}]])">Preview</a>
                <a th:if="${file.fileOwner.username == username}" href="#" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 transition" th:onclick="showEditPopup([[${file.id}]])">Edit</a>
            </div>
        </li>
    </ul>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center gap-2 mt-4"></div>

    <!-- Upload Button -->
    <button class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition self-end" onclick="showUploadPopup()">Upload file</button>
</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Edit File Access</h2>
        <form id="editAccessForm" method="post" th:action="@{/edit/file}" class="flex flex-col gap-3">
            <input type="hidden" name="fileId" id="editFileId">
            <input type="text" id="userSearchInput" placeholder="Search users..." class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]" onkeyup="filterUsers()">
            <div class="user-list max-h-52 overflow-y-auto border border-gray-700 rounded-lg p-3">
                <ul class="flex flex-col gap-2" style="list-style: none; padding:0; margin:0;">
                    <li th:each="user : ${allUsers}" th:if="${user.username} != ${username}" th:classappend="${file != null and file.authorizedUsers.contains(user)} ? 'selected-user'">
                        <label class="flex items-center gap-2 cursor-pointer user-label">
                            <img th:src="'data:image/png;base64,' + ${user.profileImageBase64}" alt="Profile" class="w-8 h-8 rounded-full"/>
                            <span th:text="${user.username}">Username</span>
                            <input type="checkbox" name="authorizedUsers" th:value="${user.id}" th:checked="${file != null and file.authorizedUsers.contains(user)}" class="hidden">
                        </label>
                    </li>
                </ul>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="flex-1 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Save</button>
                <button type="button" onclick="closeEditPopup()" class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Cancel</button>
            </div>
        </form>
        <button class="py-2 bg-red-600 text-white rounded hover:bg-red-700 transition w-full mt-3" onclick="confirmDeleteFromEdit()">Delete File</button>
    </div>
</div>

<!-- Share / Delete / Preview Popups -->
<div id="confirmSharePopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Share this file?</h2>
        <div>
            <label for="shareDurationSelect">Link expires after:</label>
            <select id="shareDurationSelect" class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full">
                <option value="1">1 Hour</option>
                <option value="12">12 Hours</option>
                <option value="24">1 Day</option>
                <option value="168">7 Days</option>
                <option value="720">30 Days</option>
            </select>
        </div>
        <div class="flex gap-2 mt-4">
            <button id="confirmShareBtn" class="flex-1 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Share</button>
            <button class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition" onclick="closeConfirmSharePopup()">Cancel</button>
        </div>
    </div>
</div>

<div id="confirmDeletePopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Really delete the file?</h2>
        <p>This file cannot be recovered. All shared links will also be deleted.</p>
        <div class="flex gap-2">
            <button id="confirmDeleteBtn" class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Delete</button>
            <button class="flex-1 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="closeConfirmDeletePopup()">Cancel</button>
        </div>
    </div>
</div>

<div id="previewPopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Preview</h2>
        <div id="previewContainer" class="flex-1 overflow-auto"></div>
        <button class="py-2 bg-red-600 text-white rounded hover:bg-red-700 transition w-full" onclick="closePreviewPopup()">Close</button>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadPopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Upload Your Files</h2>
        <form id="uploadForm" th:action="@{/upload}" method="post" enctype="multipart/form-data" class="flex flex-col gap-4" onsubmit="showLoadingBar()">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div id="dropArea" class="border-2 border-dashed border-gray-600 rounded-xl p-6 text-center cursor-pointer">
                Drag & Drop files here or click to select
                <input type="file" name="file" id="fileInput" multiple class="hidden" onchange="handleFiles(this.files)">
            </div>
            <script>
                const dropArea = document.getElementById('dropArea');
                const fileInput = document.getElementById('fileInput');
                const filePreview = document.getElementById('filePreview');

                // Klick auf Container öffnet File Dialog
                dropArea.addEventListener('click', () => fileInput.click());

                // Dateien bearbeiten (Preview anzeigen)
                function handleFiles(files) {
                    filePreview.innerHTML = ''; // alte Einträge entfernen
                    Array.from(files).forEach(file => {
                        const div = document.createElement('div');
                        div.textContent = file.name + ' (' + Math.round(file.size/1024) + ' KB)';
                        filePreview.appendChild(div);
                    });
                }

                // Optional: Drag & Drop Unterstützung
                dropArea.addEventListener('dragover', e => e.preventDefault());
                dropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    const files = e.dataTransfer.files;
                    fileInput.files = files; // setzt die Dateien für das Input-Feld
                    handleFiles(files);
                });
            </script>
            <div id="filePreview" class="flex flex-col gap-2"></div>
            <button type="submit" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Upload</button>
            <button type="button" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition" onclick="closeUploadPopup()">Cancel</button>
        </form>
    </div>
</div>

<script>
    // --- Elemente ---
    const burger = document.getElementById('burger');
    const mobileMenu = document.getElementById('mobileMenu');

    const uploadPopup = document.getElementById('uploadPopup');
    const editModal = document.getElementById('editModal');
    const editFileIdInput = document.getElementById('editFileId');

    const previewPopup = document.getElementById('previewPopup');
    const previewContainer = document.getElementById('previewContainer');

    const sharePopup = document.getElementById('confirmSharePopup');
    let currentShareFileId = null;

    const deletePopup = document.getElementById('confirmDeletePopup');
    let currentDeleteFileId = null;

    const fileList = document.getElementById('fileList');
    const paginationContainer = document.getElementById('pagination');
    const itemsPerPage = 10;
    let currentPage = 1;
    let fileItems = Array.from(fileList.children);

    // --- Burger Menu ---
    burger.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        mobileMenu.classList.toggle('flex');
    });

    // --- Upload Modal ---
    function showUploadPopup() { uploadPopup.classList.remove('hidden'); }
    function closeUploadPopup() { uploadPopup.classList.add('hidden'); }

    // --- Edit Modal ---
    function showEditPopup(fileId) { editFileIdInput.value = fileId; editModal.classList.remove('hidden'); }
    function closeEditPopup() { editModal.classList.add('hidden'); }

    // --- Preview Modal ---
    function showPreviewPopup(fileId, fileType, fileName) {
        previewContainer.innerHTML = '';
        if(fileType.startsWith('image')) {
            const img = document.createElement('img');
            img.src = '/file/' + fileId;
            img.className = 'w-full h-auto';
            previewContainer.appendChild(img);
        } else if(fileType.startsWith('video')) {
            const video = document.createElement('video');
            video.src = '/file/' + fileId;
            video.controls = true;
            video.className = 'w-full h-auto';
            previewContainer.appendChild(video);
        } else if(fileType === 'application/pdf') {
            const iframe = document.createElement('iframe');
            iframe.src = '/file/' + fileId;
            iframe.className = 'w-full h-full';
            previewContainer.appendChild(iframe);
        } else {
            const pre = document.createElement('pre');
            fetch('/file/' + fileId).then(r => r.text()).then(t => pre.innerText = t);
            previewContainer.appendChild(pre);
        }
        previewPopup.classList.remove('hidden');
    }
    function closePreviewPopup() { previewPopup.classList.add('hidden'); }

    // --- Share Modal ---
    function confirmShare(fileId) { currentShareFileId = fileId; sharePopup.classList.remove('hidden'); }
    function closeConfirmSharePopup() { currentShareFileId = null; sharePopup.classList.add('hidden'); }
    document.getElementById('confirmShareBtn').addEventListener('click', () => {
        if(currentShareFileId) {
            const duration = document.getElementById('shareDurationSelect').value;
            window.location.href = `/share/${currentShareFileId}?duration=${duration}`;
        }
    });

    // --- Delete Modal ---
    function confirmDeleteFromEdit() { currentDeleteFileId = editFileIdInput.value; editModal.classList.add('hidden'); deletePopup.classList.remove('hidden'); }
    function closeConfirmDeletePopup() { currentDeleteFileId = null; deletePopup.classList.add('hidden'); }
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
        if(currentDeleteFileId) { window.location.href = `/delete/${currentDeleteFileId}`; }
    });

    // --- Filter & Pagination ---
    function filterFiles() {
        const filter = document.getElementById('fileSearch').value.toLowerCase();

        // immer alle Items verwenden
        const allItems = Array.from(fileList.children);

        allItems.forEach(li => {
            const text = li.innerText.toLowerCase();
            li.style.display = text.includes(filter) ? '' : 'none';
        });

        // Pagination nur mit sichtbaren Items berechnen
        fileItems = allItems.filter(li => li.style.display !== 'none');

        showPage(1);
    }



    function filterUsers() {
        const filter = document.getElementById('userSearchInput').value.toLowerCase();
        document.querySelectorAll('.user-list li').forEach(li => {
            const username = li.querySelector('span').innerText.toLowerCase();
            li.style.display = username.includes(filter) ? '' : 'none';
        });
    }

    function showPage(page) {
        currentPage = page;
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        fileItems.forEach((li, index) => { li.style.display = (index >= start && index < end) ? '' : 'none'; });
        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(fileItems.length / itemsPerPage);
        paginationContainer.innerHTML = '';
        for(let i=1; i<=totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `px-3 py-1 rounded ${i === currentPage ? 'bg-[var(--color-primary)] text-white' : 'bg-[var(--color-bg-alt)] text-[var(--color-text)] hover:bg-[var(--color-primary-dark)]'}`;
            btn.addEventListener('click', () => showPage(i));
            paginationContainer.appendChild(btn);
        }
    }

    // --- Initial ---
    showPage(1);
</script>


</body>
</html>
