<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpringCloud Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/settings.css}">
    <script th:src="@{/js/navbar.js}"></script>
<!--    <script th:src="@{/js/dashboard.js}"></script>-->
</head>
<body class="bg-[var(--color-bg)] text-[var(--color-text)] font-sans min-h-screen">

<nav class="sticky top-0 z-50 w-full flex justify-between items-center flex-wrap
            bg-gradient-to-r from-[var(--color-bg)] to-[var(--color-bg-alt)]
            px-8 py-3 shadow-lg border-b-4 border-[var(--color-primary)] font-sans">

    <div class="text-2xl md:text-xl sm:text-lg font-extrabold uppercase tracking-wide
              text-[var(--color-primary)] select-none">SpringCloud</div>

    <button id="burger" class="flex flex-col justify-between w-6 h-5 ml-auto md:hidden">
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
    </button>

    <div id="username-box"
         class="relative hidden md:flex items-center gap-2 bg-[var(--color-bg-alt)] px-5 py-2 rounded-full cursor-pointer transition duration-300 shadow-md">

        <svg class="w-6 h-6 flex-shrink-0 drop-shadow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#b259ff">
            <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.2c-3.2 0-9.5 1.6-9.5 4.9v2.7h19v-2.7c0-3.3-6.3-4.9-9.5-4.9z"/>
        </svg>
        <span th:text="${username}" class="text-white font-semibold">N/A</span>

        <div id="logoutDropdown"
             class="absolute top-full right-0 mt-3 w-56 bg-[var(--color-bg-alt)] rounded-xl shadow-xl opacity-0 pointer-events-none transform -translate-y-2 transition-all duration-300">
            <div class="flex flex-col py-2">
                <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/admin}"
                   class="px-5 py-3 text-[var(--color-primary)] font-bold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Admin</a>
                <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
                   class="px-5 py-3 text-[var(--color-primary)] font-bold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Add Users</a>
                <a th:href="@{/calendar}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Calendar</a>
                <a th:href="@{/settings}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Settings</a>
                <a th:href="@{/logout}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Logout</a>
            </div>
        </div>
    </div>

    <div id="mobileMenu" class="hidden flex-col bg-[var(--color-bg-alt)] rounded-xl mt-4 p-4 gap-3 w-full md:hidden">
        <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/admin}"
           class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Admin</a>
        <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
           class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Add Users</a>
        <a th:href="@{/calendar}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Calendar</a>
        <a th:href="@{/settings}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Settings</a>
        <a th:href="@{/logout}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Logout</a>
    </div>
</nav>

<div class="content px-6 py-8 max-w-[75rem] mx-auto flex flex-col gap-12">

    <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
        <!-- Folder Selection -->
        <div class="flex-1 md:max-w-xs">
            <label for="folderSelectTop" class="block text-[var(--color-text)] font-semibold mb-2">Select Folder</label>
            <select id="folderSelectTop" name="folderId" class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full" onchange="filterFiles()">
                <option value="">Root</option>
                <option th:each="folder : ${subFolders}"
                        th:value="${folder.id}"
                        th:text="${folder.folderName}"></option>
            </select>
        </div>

        <!-- File Search -->
        <div class="flex-1 md:max-w-md">
            <label for="fileSearch" class="block text-[var(--color-text)] font-semibold mb-2 md:hidden">Search Files</label>
            <input type="text" id="fileSearch" placeholder="Search files..." class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full" oninput="filterFiles()">
        </div>

        <!-- Buttons -->
        <div class="flex gap-2">
            <button id="deleteFolderBtn"
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                    onclick="showDeleteFolderPopup()">
                Delete Folder
            </button>
            <button class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition" onclick="showFolderPopup()">Create Folder</button>
            <button class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition" onclick="showUploadPopup()">Upload File</button>
        </div>
    </div>


    <div class="overflow-x-auto hidden md:block">
        <table class="min-w-full bg-[var(--color-bg-alt)] rounded-xl shadow">
            <thead class="bg-[var(--color-container-hover)]">
            <tr>
                <th class="px-4 py-2 text-left text-sm font-semibold text-[var(--color-text-light)]">File Name</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-[var(--color-text-light)]">Type</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-[var(--color-text-light)]">Uploader</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-[var(--color-text-light)]">Uploaded</th>
                <th class="px-4 py-2 text-right text-sm font-semibold text-[var(--color-text-light)]">Actions</th>
            </tr>
            </thead>
            <tbody id="fileList" class="divide-y divide-gray-700">
            <tr th:each="file : ${files}" th:attr="data-folder-id=${file.folder != null ? file.folder.id : ''}" class="hover:bg-[var(--color-container-hover)] transition">
                <td class="px-4 py-3 font-semibold text-white" th:text="${file.fileName}">File Name</td>
                <td class="px-4 py-3 text-sm text-[var(--color-text-light)]" th:text="${file.fileType}">File Type</td>
                <td class="px-4 py-3 text-sm text-[var(--color-text-light)]" th:text="${file.fileOwner.username}">Uploader</td>
                <td class="px-4 py-3 text-sm text-[var(--color-text-light)]" th:text="${#temporals.format(file.uploadTime, 'dd.MM.yyyy HH:mm')}">Upload Date</td>
                <td class="px-4 py-3 flex justify-end gap-2">
                    <a th:if="${file.fileOwner.username == username}"
                       href="#"
                       class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                       th:onclick="confirmShare([[${file.id}]])">Share</a>
                    <a th:href="@{'/download/' + ${file.id}}"
                       class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition">Download</a>
                    <a href="#"
                       class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition"
                       th:onclick="showPreviewPopup([[${file.id}]], [[${file.fileType}]], [[${file.fileName}]])">Preview</a>
                    <a th:if="${file.fileOwner.username == username}"
                       href="#"
                       class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 transition"
                       th:onclick="showEditPopup([[${file.id}]])">Edit</a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="flex flex-col gap-3 md:hidden" id="fileListMobile">
        <div th:each="file : ${files}"
             th:attr="data-folder-id=${file.folder != null ? file.folder.id : ''}"
             class="file-card bg-[var(--color-bg-alt)] rounded-lg p-4 flex justify-between items-center shadow">
            <div>
                <div class="text-white font-semibold" th:text="${file.fileName}">File Name</div>
                <div class="text-sm text-[var(--color-text-light)]" th:text="${file.fileType}">File Type</div>
            </div>
            <div class="relative">
                <button onclick="toggleFileMenu(this)" class="p-2 rounded-full hover:bg-[var(--color-container-hover)]">
                    â‹®
                </button>
                <div class="file-menu hidden absolute right-0 mt-2 w-40 bg-[var(--color-bg-alt)] border border-gray-700 rounded-lg shadow-lg z-20 flex flex-col opacity-0 transform scale-95 transition-all duration-200">
                    <a th:href="@{'/download/' + ${file.id}}" class="px-4 py-2 hover:bg-[var(--color-container-hover)] text-white">Download</a>
                    <a href="#" class="px-4 py-2 hover:bg-[var(--color-container-hover)] text-white" th:onclick="showPreviewPopup([[${file.id}]], [[${file.fileType}]], [[${file.fileName}]])">Preview</a>
                    <a th:if="${file.fileOwner.username == username}" href="#" class="px-4 py-2 hover:bg-[var(--color-container-hover)] text-white" th:onclick="confirmShare([[${file.id}]])">Share</a>
                    <a th:if="${file.fileOwner.username == username}" href="#" class="px-4 py-2 hover:bg-[var(--color-container-hover)] text-white" th:onclick="showEditPopup([[${file.id}]])">Edit</a>
                </div>
            </div>
        </div>
    </div>

    <div id="pagination" class="flex justify-center gap-2 mt-4"></div>

</div>

<div id="editModal" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Edit File Access</h2>
        <form id="editAccessForm" method="post" th:action="@{/edit/file}" class="flex flex-col gap-3">
            <input type="hidden" name="fileId" id="editFileId">
            <input type="text" id="userSearchInput" placeholder="Search users..." class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]" onkeyup="filterUsers()">
            <div class="user-list max-h-52 overflow-y-auto border border-gray-700 rounded-lg p-3">
                <ul class="flex flex-col gap-2" style="list-style: none; padding:0; margin:0;">
                    <li th:each="user : ${allUsers}"
                        th:if="${user.username} != ${username}"
                        th:classappend="${file != null and file.authorizedUsers.contains(user)} ? ' border-2 border-purple-500 rounded-lg bg-purple-100'">
                        <label class="flex items-center gap-2 cursor-pointer p-2 user-label">
                            <img th:src="'data:image/png;base64,' + ${user.profileImageBase64}" class="w-8 h-8 rounded-full"/>
                            <input class="hidden" type="checkbox" name="authorizedUsers" th:value="${user.id}"
                                   th:checked="${file != null and file.authorizedUsers.contains(user)}">
                            <span th:text="${user.username}"></span>
                        </label>
                    </li>
                </ul>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="flex-1 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Save</button>
                <button type="button" onclick="closeEditPopup()" class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Cancel</button>
            </div>
        </form>
        <button class="py-2 bg-red-600 text-white rounded hover:bg-red-700 transition w-full mt-3" onclick="confirmDeleteFromEdit()">Delete File</button>
    </div>
</div>

<div id="confirmSharePopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Share this file?</h2>
        <div>
            <label for="shareDurationSelect">Link expires after:</label>
            <select id="shareDurationSelect" class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full">
                <option value="1">1 Hour</option>
                <option value="12">12 Hours</option>
                <option value="24">1 Day</option>
                <option value="168">7 Days</option>
                <option value="720">30 Days</option>
            </select>
        </div>
        <div class="flex gap-2 mt-4">
            <button id="confirmShareBtn" class="flex-1 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Share</button>
            <button class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition" onclick="closeConfirmSharePopup()">Cancel</button>
        </div>
    </div>
</div>

<div id="folderPopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Create New Folder</h2>
        <form id="folderForm" th:action="@{/createFolder}" method="post" class="flex flex-col gap-4">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div>
                <label for="folderName" class="block text-[var(--color-text)] font-semibold mb-2">Folder Name</label>
                <input type="text" id="folderName" name="folderName"
                       class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full"
                       placeholder="Enter folder name..." required>
            </div>

            <div class="flex gap-2">
                <button type="submit" class="flex-1 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Create</button>
                <button type="button" onclick="closeFolderPopup()" class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmDeletePopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Really delete the file?</h2>
        <p>This file cannot be recovered. All shared links will also be deleted.</p>
        <div class="flex gap-2">
            <button id="confirmDeleteBtn" class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Delete</button>
            <button class="flex-1 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition" onclick="closeConfirmDeletePopup()">Cancel</button>
        </div>
    </div>
</div>

<div id="previewPopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Preview</h2>
        <div id="previewContainer" class="flex-1 overflow-auto"></div>
        <button class="py-2 bg-red-600 text-white rounded hover:bg-red-700 transition w-full" onclick="closePreviewPopup()">Close</button>
    </div>
</div>

<div id="deleteFolderPopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Really delete this folder?</h2>
        <p>All files inside this folder will also be deleted. This action cannot be undone.</p>
        <div class="flex gap-2 mt-4">
            <form id="deleteFolderForm" th:action="@{/deleteFolder}" method="post" class="flex-1">
                <input type="hidden" name="folderId" id="deleteFolderId">
                <button type="submit" class="w-full py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">
                    Delete
                </button>
            </form>
            <button onclick="closeDeleteFolderPopup()"
                    class="flex-1 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                Cancel
            </button>
        </div>
    </div>
</div>



<div id="uploadPopup" class="hidden popup-overlay">
    <div class="popup-container">
        <h2 class="text-xl font-bold text-[var(--color-primary)]">Upload Your Files</h2>
        <form id="uploadForm" th:action="@{/upload}" method="post" enctype="multipart/form-data" class="flex flex-col gap-4" onsubmit="showLoadingBar()">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div id="dropArea" class="border-2 border-dashed border-gray-600 rounded-xl p-6 text-center cursor-pointer">
                Drag & Drop files here or click to select
                <input type="file" name="file" id="fileInput" multiple class="hidden" onchange="handleFiles(this.files)">
            </div>
            <div id="filePreview" class="flex flex-col gap-2"></div>
            <script>
                const dropArea = document.getElementById('dropArea');
                const fileInput = document.getElementById('fileInput');
                const filePreview = document.getElementById('filePreview');

                let selectedFiles = [];

                dropArea.addEventListener('click', () => fileInput.click());

                fileInput.addEventListener('change', (e) => {
                    selectedFiles = Array.from(e.target.files);
                    displayFiles();
                });

                dropArea.addEventListener('dragover', e => e.preventDefault());

                dropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    selectedFiles = Array.from(e.dataTransfer.files);
                    displayFiles();
                });

                function displayFiles() {
                    filePreview.innerHTML = '';
                    selectedFiles.forEach((file, index) => {
                        const div = document.createElement('div');
                        div.className = "flex justify-between items-center bg-[var(--color-input)] px-3 py-1 rounded";
                        div.innerHTML = `
                            <span>${file.name} (${Math.round(file.size/1024)} KB)</span>
                            <button type="button" class="text-red-600 font-bold" onclick="removeFile(${index})">X</button>
                        `;
                        filePreview.appendChild(div);
                    });
                }

                function removeFile(index) {
                    selectedFiles.splice(index, 1);
                    displayFiles();
                }

                document.getElementById('uploadForm').addEventListener('submit', function(e){
                    if(selectedFiles.length > 0){
                        const formData = new FormData(this);
                        selectedFiles.forEach(file => formData.append('file', file));

                        fetch(this.action, {
                            method: this.method,
                            body: formData
                        }).then(res => {
                            location.reload();
                        }).catch(err => console.error(err));

                        e.preventDefault();
                    }
                });
            </script>
            <div>
                <label for="folderSelect" class="block text-[var(--color-text)] font-semibold mb-2">Upload to folder</label>
                <select id="folderSelect" name="folderId" class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full">
                    <option value="">Root</option>
                    <option th:each="folder : ${subFolders}" th:value="${folder.id}" th:text="${folder.folderName}"></option>
                </select>
            </div>
            <button type="submit" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Upload</button>
            <button type="button" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition" onclick="closeUploadPopup()">Cancel</button>
        </form>
    </div>
</div>
<script th:src="@{/js/dashboard.js}"></script>
</body>
</html>
