<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpringCloud Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <script th:src="@{/js/navbar.js}"></script>
</head>
<body>

<div class="navbar no-select">
    <div class="brand">SpringCloud</div>
    <div class="username-box" id="usernameBox">
        <svg class="user-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#b259ff" width="24" height="24" aria-hidden="true">
            <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.2c-3.2 0-9.5 1.6-9.5 4.9v2.7h19v-2.7c0-3.3-6.3-4.9-9.5-4.9z"/>
        </svg>
        <span th:text="${username}">N/A</span>
        <div class="logout-dropdown" id="logoutDropdown">
            <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/admin}" class="admin-element">Admin</a>
            <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}" class="admin-element">Add Users</a>
            <a th:href="@{/calendar}">Calendar</a>
            <a th:href="@{/change-password}">Change Password</a>
            <a th:href="@{/logout}">Logout</a>
        </div>
    </div>
</div>

<div class="content">
    <h1>Welcome to your Cloud Dashboard!</h1>

    <ul class="file-list" id="fileList">
        <li th:each="file : ${files}">
            <div class="file-info">
                <span th:text="${file.fileName}">File Name</span>
                <span th:text="${file.fileType}">File Type</span>
                <span th:text="${file.fileOwner.username}">Uploader</span>
                <span th:text="${#temporals.format(file.uploadTime, 'dd.MM.yyyy HH:mm')}">Upload Date</span>
            </div>
            <div class="actions">
                <a href="#" class="share" th:onclick="confirmShare([[${file.id}]])">Share</a>
                <a th:href="@{'/download/' + ${file.id}}">Download</a>
                <a th:onclick='showPreviewPopup([[${file.id}]], [[${file.fileType}]], [[${file.fileName}]])'>Preview</a>
                <a href="#" class="delete" th:onclick="confirmDelete([[${file.id}]])">Delete</a>
            </div>
        </li>
    </ul>
</div>

<button class="upload-btn" onclick="showUploadPopup()">Upload file</button>

<div id="confirmSharePopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
        <h2>Share this file?</h2>
        <p>Select how long the link should be valid:</p>
        <div class="select-container">
            <label for="shareDurationSelect">Link expires after:</label>
            <select id="shareDurationSelect">
                <option value="1">1 Hour</option>
                <option value="12">12 Hours</option>
                <option value="24">1 Day</option>
                <option value="168">7 Days</option>
                <option value="720">30 Days</option>
            </select>
        </div>
        <div class="popup-buttons" style="margin-top: 20px;">
            <button id="confirmShareBtn">Share</button>
            <button class="close-btn" onclick="closeConfirmSharePopup()">Cancel</button>
        </div>
    </div>
</div>


<div id="confirmDeletePopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
        <h2>Really delete the file?</h2>
        <p>
            This file cannot be recovered.<br>
            All shared links will also be deleted.</p>
        <div class="popup-buttons">
            <button id="confirmDeleteBtn">Delete</button>
            <button class="close-btn" onclick="closeConfirmDeletePopup()">Cancel</button>
        </div>
    </div>
</div>

<div id="uploadPopup">
    <div class="popup-content">
        <h2>Upload Your File</h2>
        <form id="uploadForm" th:action="@{/upload}" method="post" enctype="multipart/form-data" onsubmit="showLoadingBar()">
            <input type="file" name="file" id="fileInput">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">Upload</button>
        </form>
        <button class="close-btn" onclick="closeUploadPopup()">Close</button>
    </div>
</div>

<div id="previewPopup">
    <div class="popup-content">
        <h2>Preview</h2>
        <div id="previewContainer"></div>
        <button class="close-btn" onclick="closePreviewPopup()">Close</button>
    </div>
</div>
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-bar" id="loadingBar" style="width: 0%;"></div>
    <div class="loading-circle"></div>
    <div class="loading-content">Uploading...</div>
</div>
<script>

    let deleteFileId = null;

    let shareFileId = null;

    function confirmShare(fileId) {
        shareFileId = fileId;
        document.getElementById('confirmSharePopup').style.display = 'flex';
    }

    function closeConfirmSharePopup() {
        shareFileId = null;
        document.getElementById('confirmSharePopup').style.display = 'none';
    }

    document.getElementById('confirmShareBtn').addEventListener('click', function () {
        if (shareFileId !== null) {
            const durationHours = document.getElementById('shareDurationSelect').value;
            window.location.href = `/share/${shareFileId}?duration=${durationHours}`;
        }
    });


    function confirmDelete(fileId) {
        deleteFileId = fileId;
        document.getElementById('confirmDeletePopup').style.display = 'flex';
    }

    function closeConfirmDeletePopup() {
        deleteFileId = null;
        document.getElementById('confirmDeletePopup').style.display = 'none';
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (deleteFileId !== null) {
            window.location.href = `/delete/${deleteFileId}`;
        }
    });

    function showLoadingBar() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function showUploadPopup() {
        document.getElementById('uploadPopup').style.display = 'flex';
    }

    function closeUploadPopup() {
        document.getElementById('uploadPopup').style.display = 'none';
    }

    function showPreviewPopup(fileId, fileType, fileName) {
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = '';

        if (fileType.startsWith('image/')) {
            previewContainer.innerHTML = `<img src="/file/${fileId}" alt="${fileName}" style="max-width: 100%; max-height: 100%;">`;
        }

        else if (fileType.startsWith('video/')) {
            previewContainer.innerHTML = `<video controls style="max-width: 100%; max-height: 100%;"> <source src="/file/${fileId}" type="${fileType}"> Your browser does not support the video tag. </video>`;
        }

        else if (fileType.startsWith('text/')) {
            fetch(`/file/${fileId}`).then(response => response.text()).then(data => {
                if (fileType === 'application/json') {

                    try {
                        data = JSON.stringify(JSON.parse(data), null, 4);
                    } catch (e) {
                        data = "Error parsing JSON.";
                    }
                }
                previewContainer.innerHTML = `<pre>${data}</pre>`;
            }).catch(error => {
                previewContainer.innerHTML = `<p>Error loading text file</p>`;
            });
        }

        else if (fileType === 'application/pdf') {
            previewContainer.innerHTML = `<embed src="/file/${fileId}" type="application/pdf" width="100%" height="100%"></embed>`;
        }
        else {
            previewContainer.innerHTML = `<p>No preview available for this file type</p>`;
        }

        document.getElementById('previewPopup').style.display = 'flex';
    }


    function closePreviewPopup() {
        document.getElementById('previewPopup').style.display = 'none';
    }

</script>
</body>
</html>
