<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpringCloud Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
</head>
<body>

<div class="navbar">
    <div class="brand">SpringCloud</div>
    <div class="username-box">
        <span th:text="${username}">Username</span>
        <div class="logout-dropdown" id="logoutDropdown">
            <a th:if="${role == 'ROLE_ADMIN'}" th:href="@{/admin}">Admin</a>
            <a th:if="${role == 'ROLE_ADMIN'}" th:href="@{/register}">Add Users</a>
            <a th:href="@{/change-password}">Change Password</a>
            <a th:href="@{/logout}">Logout</a>
        </div>
    </div>
</div>

<div class="content">
    <h1>Welcome to your Cloud Dashboard!</h1>

    <ul class="file-list" id="fileList">
        <li th:each="file : ${files}">
            <div class="file-info">
                <span th:text="${file.fileName}">File Name</span>
                <span th:text="${file.fileType}">File Type</span>
                <span th:text="${file.fileOwner.username}">Uploader</span>
                <span th:text="${#temporals.format(file.uploadTime, 'dd.MM.yyyy HH:mm')}">Upload Date</span>
            </div>
            <div class="actions">
                <a th:href="@{'/share/' + ${file.id}}">Share</a>
                <a th:href="@{'/download/' + ${file.id}}">Download</a>
                <a th:onclick='showPreviewPopup([[${file.id}]], [[${file.fileType}]], [[${file.fileName}]])'>Preview</a>
                <a th:href="@{'/delete/' + ${file.id}}" class="delete">Delete</a>
            </div>
        </li>
    </ul>
</div>

<button class="upload-btn" onclick="showUploadPopup()">+</button>

<div id="uploadPopup">
    <div class="popup-content">
        <h2>Upload Your File</h2>
        <form id="uploadForm" th:action="@{/upload}" method="post" enctype="multipart/form-data" onsubmit="showLoadingBar()">
            <input type="file" name="file" id="fileInput">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">Upload</button>
        </form>
        <button class="close-btn" onclick="closeUploadPopup()">Close</button>
    </div>
</div>

<div id="previewPopup">
    <div class="popup-content">
        <h2>Preview</h2>
        <div id="previewContainer"></div>
        <button class="close-btn" onclick="closePreviewPopup()">Close</button>
    </div>
</div>
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-bar" id="loadingBar" style="width: 0%;"></div>
    <div class="loading-circle"></div>
    <div class="loading-content">Uploading...</div>
</div>
<script>

    function showLoadingBar() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

        function showUploadPopup() {
            document.getElementById('uploadPopup').style.display = 'flex';
        }

        function closeUploadPopup() {
            document.getElementById('uploadPopup').style.display = 'none';
        }

        function showPreviewPopup(fileId, fileType, fileName) {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';

            if (fileType.startsWith('image/')) {
                previewContainer.innerHTML = `<img src="/file/${fileId}" alt="${fileName}" style="max-width: 100%; max-height: 100%;">`;
            }

            else if (fileType.startsWith('video/')) {
                previewContainer.innerHTML = `<video controls style="max-width: 100%; max-height: 100%;"> <source src="/file/${fileId}" type="${fileType}"> Your browser does not support the video tag. </video>`;
            }

            else if (fileType.startsWith('text/')) {
                fetch(`/file/${fileId}`).then(response => response.text()).then(data => {
                    if (fileType === 'application/json') {

                        try {
                            data = JSON.stringify(JSON.parse(data), null, 4);
                        } catch (e) {
                            data = "Error parsing JSON.";
                        }
                    }
                    previewContainer.innerHTML = `<pre>${data}</pre>`;
                }).catch(error => {
                    previewContainer.innerHTML = `<p>Error loading text file</p>`;
                });
            }

            else if (fileType === 'application/pdf') {
                previewContainer.innerHTML = `<embed src="/file/${fileId}" type="application/pdf" width="100%" height="100%"></embed>`;
            }
            else {
                previewContainer.innerHTML = `<p>No preview available for this file type</p>`;
            }

            document.getElementById('previewPopup').style.display = 'flex';
        }


        function closePreviewPopup() {
            document.getElementById('previewPopup').style.display = 'none';
        }

</script>
</body>
</html>
