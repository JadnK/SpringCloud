<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpringCloud Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/settings.css}">
    <script th:src="@{/js/navbar.js}"></script>
</head>
<body class="bg-[var(--color-bg)] text-[var(--color-text)] font-sans min-h-screen">

<!-- Navbar -->
<nav class="flex justify-between items-center flex-wrap
            bg-gradient-to-r from-[var(--color-bg)] to-[var(--color-bg-alt)]
            px-8 py-3 shadow-lg border-b-4 border-[var(--color-primary)] font-sans relative z-50">

    <div class="text-2xl md:text-xl sm:text-lg font-extrabold uppercase tracking-wide
              text-[var(--color-primary)] select-none">SpringCloud</div>

    <button id="burger" class="flex flex-col justify-between w-6 h-5 ml-auto md:hidden">
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
    </button>

    <div id="username-box"
         class="relative hidden md:flex items-center gap-2 bg-[var(--color-bg-alt)] px-5 py-2 rounded-full cursor-pointer transition duration-300 shadow-md">

        <svg class="w-6 h-6 flex-shrink-0 drop-shadow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#b259ff">
            <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.2c-3.2 0-9.5 1.6-9.5 4.9v2.7h19v-2.7c0-3.3-6.3-4.9-9.5-4.9z"/>
        </svg>
        <span th:text="${username}" class="text-white font-semibold">N/A</span>

        <!-- Dropdown -->
        <div id="logoutDropdown"
             class="absolute top-full right-0 mt-3 w-56 bg-[var(--color-bg-alt)] rounded-xl shadow-xl opacity-0 pointer-events-none transform -translate-y-2 transition-all duration-300">
            <div class="flex flex-col py-2">
                <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
                   class="px-5 py-3 text-[var(--color-primary)] font-bold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Add Users</a>
                <a th:href="@{/dashboard}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Dashboard</a>
                <a th:href="@{/settings}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Settings</a>
                <a th:href="@{/logout}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Logout</a>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden flex-col bg-[var(--color-bg-alt)] rounded-xl mt-4 p-4 gap-3 w-full md:hidden">
        <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
           class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Add Users</a>
        <a th:href="@{/dashboard}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Dashboard</a>
        <a th:href="@{/calendar}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Calendar</a>
        <a th:href="@{/settings}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Settings</a>
        <a th:href="@{/logout}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Logout</a>
    </div>
</nav>

<!-- Content -->
<div class="content px-6 py-8 max-w-[75rem] mx-auto flex flex-col gap-12">

    <!-- Users Table -->
    <section class="bg-[var(--color-bg-alt)] rounded-xl shadow-md p-6">
        <h2 class="text-2xl font-bold text-[var(--color-primary)] mb-4">Users</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left table-auto border-separate border-spacing-2">
                <thead>
                <tr class="bg-[rgba(255,255,255,0.1)]">
                    <th class="px-4 py-2">Username</th>
                    <th class="px-4 py-2">Email</th>
                    <th class="px-4 py-2">Role</th>
                    <th class="px-4 py-2">Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${users}" class="hover:bg-[var(--color-container-hover)] transition">
                    <td class="px-4 py-2" th:text="${user.username}">Username</td>
                    <td class="px-4 py-2" th:text="${user.email}">Email</td>
                    <td class="px-4 py-2">
                        <span th:each="role : ${user.role}" th:text="${role.name}">Role</span>
                    </td>
                    <td class="px-4 py-2 flex gap-2">
                        <button class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition"
                                th:if="${username != user.username} and (${role == 'ROLE_SYSADMIN'} or (${role == 'ROLE_ADMIN'} and ${user.role.name} != 'ROLE_ADMIN' and ${user.role.name} != 'SYSADMIN'))"
                                th:attr="data-id=${user.id}, data-username=${user.username}, data-email=${user.email}, data-user-role=${user.role.name}"
                                onclick="showEditPopupFromButton(this)">Edit
                        </button>
                        <form th:if="${username != user.username} and (${role == 'ROLE_SYSADMIN'} or (${role == 'ROLE_ADMIN'} and ${user.role.name} != 'ROLE_ADMIN' and ${user.role.name} != 'SYSADMIN'))"
                              th:action="@{/admin/user/ban/{id}(id=${user.id})}" method="get" class="inline">
                            <button class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition"
                                    type="submit"
                                    th:text="${user.banned} ? 'Unban' : 'Ban'"></button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Logs -->
    <section class="bg-[var(--color-bg-alt)] rounded-xl shadow-md p-6 flex flex-col gap-4">
        <h2 class="text-2xl font-bold text-[var(--color-primary)]">Logs</h2>
        <div class="flex gap-4 flex-wrap mb-4">
            <input type="text" id="logUserSearch" placeholder="Search for Users"
                   class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none"
                   oninput="filterLogs()">
            <input type="date" id="logDateSearch"
                   class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none"
                   oninput="filterLogs()">
        </div>
        <div th:each="log : ${logs}" class="log-entry p-3 rounded-lg bg-[var(--color-container-hover)] shadow" th:id="'log-' + ${log.id}">
            <div class="log-info text-sm">
                <span th:text="${log.action}">Action</span> –
                <span class="log-timestamp" th:text="${#temporals.format(log.timestamp, 'dd.MM.yyyy HH:mm')}"
                      th:attr="data-date=${#temporals.format(log.timestamp, 'yyyy-MM-dd')}"></span>
                <p>Executed by: <span th:text="${log.user.username}">Username</span></p>
            </div>
        </div>
    </section>

    <!-- Webhook Settings -->
    <section class="bg-[var(--color-bg-alt)] rounded-xl shadow-md p-6 flex flex-col gap-4">
        <h2 class="text-2xl font-bold text-[var(--color-primary)]">Webhook Settings</h2>
        <form action="/webhooks/add" method="post" enctype="multipart/form-data" class="flex flex-col gap-4">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="webhookUrl" name="url" placeholder="Webhook URL"
                       class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full"/>
                <input type="text" id="webhookName" name="webhookName" placeholder="Webhook Name"
                       class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full"/>
                <input type="file" id="webhookPicture" name="webhookPicture" accept="image/*"
                       class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full"/>
            </div>
            <div class="flex flex-wrap gap-3">
                <label><input type="checkbox" name="onUserCreation"> User created</label>
                <label><input type="checkbox" name="onUserBan"> User banned</label>
                <label><input type="checkbox" name="onUserUpdate"> User updated</label>
                <label><input type="checkbox" name="onRegister"> User registered</label>
                <label><input type="checkbox" name="onErrorThrown"> Error</label>
                <label><input type="checkbox" name="onFileDeletion"> File deleted</label>
                <label><input type="checkbox" name="onFileUpload"> File uploaded</label>
                <label><input type="checkbox" name="onSystemEvent"> System Events</label>
                <label><input type="checkbox" name="onCalendarNotification"> Calendar Notify</label>
            </div>
            <button type="submit" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Add Webhook</button>
        </form>
    </section>

    <!-- Site Settings -->
    <section class="bg-[var(--color-bg-alt)] rounded-xl shadow-md p-6 flex flex-col gap-4">
        <h2 class="text-2xl font-bold text-[var(--color-primary)]">Site Settings</h2>
        <div th:each="setting : ${settings}" class="flex flex-col gap-3">
            <form th:action="@{/admin/settings/update}" method="post" class="flex flex-col gap-2">
                <input type="hidden" name="key" th:value="${setting.key}" />
                <input type="hidden" name="type" th:value="${setting.type}" />

                <label th:for="${setting.key}" class="font-semibold" th:text="${setting.key}">Setting Name</label>

                <input th:if="${setting.type == 'TEXT'}"
                       type="text"
                       th:id="${setting.key}"
                       name="value"
                       th:value="${setting.value}"
                       placeholder="Enter value"
                       class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]"/>

                <div th:if="${setting.type == 'CHECKBOX'}" class="flex items-center gap-2">
                    <span>On</span>
                    <input th:if="${setting.type == 'CHECKBOX'}"
                           type="checkbox"
                           th:id="${setting.key}"
                           name="value"
                           value="true"
                           th:checked="${setting.value == 'true'}"
                           class="h-5 w-5 accent-[var(--color-primary)]"/>
                    <span>Off</span>
                </div>

                <input th:if="${setting.type == 'NUMBER'}"
                       type="number"
                       th:id="${setting.key}"
                       name="value"
                       th:value="${setting.value}"
                       min="1" max="100"
                       class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]"/>

                <button type="submit" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Save</button>
            </form>
        </div>
    </section>

    <!-- API Settings -->
    <section class="bg-[var(--color-bg-alt)] rounded-xl shadow-md p-6 flex flex-col gap-4">
        <h2 class="text-2xl font-bold text-[var(--color-primary)]">API Settings</h2>
        <form action="/api/s/add" method="post" enctype="multipart/form-data" class="flex flex-col gap-4">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="text" id="apiName" name="apiName" placeholder="API Name" required
                   class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] w-full"/>
            <button type="submit" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Add API</button>
        </form>

        <div class="flex flex-col gap-3 mt-4">
            <div class="flex flex-col gap-3" th:each="apii : ${apis}">
                <div class="flex justify-between items-center bg-[var(--color-container-hover)] p-4 rounded-lg shadow">
                    <div>
                        <p><strong>Name:</strong> <span th:text="${apii.name}">Name</span></p>
                        <p><strong>Token:</strong> <span th:text="${apii.token}">token</span></p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <form th:action="@{/api/s/toggle/{id}(id=${apii.id})}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="active" th:checked="${apii.active} ? 'checked' : null" onchange="this.form.submit()" class="h-5 w-10 rounded-full accent-[var(--color-primary)]"/>
                            </label>
                        </form>
                        <form th:action="@{/api/s/delete/{id}(id=${apii.id})}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Update Section -->
    <section class="bg-[var(--color-bg-alt)] rounded-xl shadow-md p-6 flex flex-col gap-4">
        <h2 class="text-2xl font-bold text-[var(--color-primary)]">Update</h2>
        <div class="flex flex-col gap-2">
            <p><strong>Current Version:</strong> <span th:text="${currentVersion}">v1.0.0</span></p>
            <p><strong>Newest Version:</strong> <span th:text="${latestVersion}">v1.0.0</span></p>

            <div th:if="${currentVersion != latestVersion}">
                <form th:action="@{/admin/system/update}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Update</button>
                </form>
            </div>
            <div th:if="${currentVersion == latestVersion}">
                <p class="text-green-500 font-semibold">✅ System is on the newest Release.</p>
            </div>
        </div>
    </section>

</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden fixed inset-0 z-50 bg-[rgba(15,15,30,0.9)] flex items-center justify-center">
    <div class="bg-[var(--color-bg-alt)] rounded-xl shadow-lg p-6 w-[90vw] max-w-md flex flex-col gap-4">
        <form id="editForm" th:action="@{/admin/user/update}" method="post" class="flex flex-col gap-3">
            <input type="hidden" name="id" id="editUserId">
            <input type="text" name="username" id="editUsername" placeholder="Username"
                   class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]"/>
            <input type="email" name="email" id="editEmail" placeholder="Email"
                   class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]"/>
            <select name="role" id="editRole" class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]">
                <option th:each="role : ${roles}" th:if="${role.name != 'SYSADMIN'}" th:value="${role.name}" th:text="${role.name}"></option>
            </select>
            <input type="password" name="password" id="editPassword" placeholder="New Password"
                   class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)]"/>
            <div class="flex gap-2">
                <button type="submit" class="flex-1 py-2 bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-hover)] transition">Save</button>
                <button type="button" onclick="closeEditPopup()" class="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showEditPopupFromButton(button) {
        const id = button.getAttribute('data-id');
        const username = button.getAttribute('data-username');
        const email = button.getAttribute('data-email');
        const user_role = button.getAttribute('data-user-role');

        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = user_role;
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditPopup() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function filterLogs() {
        const usernameFilter = document.getElementById('logUserSearch').value.toLowerCase();
        const dateFilter = document.getElementById('logDateSearch').value;
        const logEntries = document.querySelectorAll('.log-entry');

        logEntries.forEach(function (logEntry) {
            const username = logEntry.querySelector('.log-info span:last-child')?.innerText.toLowerCase() || '';
            const timestampDate = logEntry.querySelector('.log-timestamp')?.dataset.date || '';
            const matchesUsername = username.includes(usernameFilter);
            const matchesDate = dateFilter ? timestampDate === dateFilter : true;
            logEntry.style.display = (matchesUsername && matchesDate) ? '' : 'none';
        });
    }

    const burger = document.getElementById('burger');
    const mobileMenu = document.getElementById('mobileMenu');
    burger.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        mobileMenu.classList.toggle('flex');
    });
</script>
</body>
</html>
