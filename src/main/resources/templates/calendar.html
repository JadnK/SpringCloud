<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalender</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/settings.css}">
    <script th:src="@{/js/navbar.js}"></script>
</head>
<body class="bg-[var(--color-bg)] text-[var(--color-text)] font-sans min-h-screen">

<!-- Alert Fragment -->
<div th:replace="~{fragments/alert}"></div>

<!-- Navbar (wie vorher) -->
<nav class="sticky top-0 z-50 w-full flex justify-between items-center flex-wrap
            bg-gradient-to-r from-[var(--color-bg)] to-[var(--color-bg-alt)]
            px-8 py-3 shadow-lg border-b-4 border-[var(--color-primary)] font-sans">

    <div class="text-2xl md:text-xl sm:text-lg font-extrabold uppercase tracking-wide
              text-[var(--color-primary)] select-none">SpringCloud</div>

    <button id="burger" class="flex flex-col justify-between w-6 h-5 ml-auto md:hidden">
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
        <span class="h-[3px] bg-[var(--color-primary)] rounded transition-all"></span>
    </button>

    <div id="username-box"
         class="relative hidden md:flex items-center gap-2 bg-[var(--color-bg-alt)] px-5 py-2 rounded-full cursor-pointer transition duration-300 shadow-md">

        <svg class="w-6 h-6 flex-shrink-0 drop-shadow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#b259ff">
            <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.2c-3.2 0-9.5 1.6-9.5 4.9v2.7h19v-2.7c0-3.3-6.3-4.9-9.5-4.9z"/>
        </svg>
        <span th:text="${username}" class="text-white font-semibold">N/A</span>

        <!-- Dropdown -->
        <div id="logoutDropdown"
             class="absolute top-full right-0 mt-3 w-56 bg-[var(--color-bg-alt)] rounded-xl shadow-xl opacity-0 pointer-events-none transform -translate-y-2 transition-all duration-300">
            <div class="flex flex-col py-2">
                <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/admin}"
                   class="px-5 py-3 text-[var(--color-primary)] font-bold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Admin</a>
                <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
                   class="px-5 py-3 text-[var(--color-primary)] font-bold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Add Users</a>
                <a th:href="@{/dashboard}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Dashboard</a>
                <a th:href="@{/settings}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Settings</a>
                <a th:href="@{/logout}" class="px-5 py-3 text-white rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-bg)]">Logout</a>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden flex-col bg-[var(--color-bg-alt)] rounded-xl mt-4 p-4 gap-3 w-full md:hidden">
        <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/admin}"
           class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Admin</a>
        <a th:if="${role != null and #strings.endsWith(role, 'ADMIN')}" th:href="@{/register}"
           class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Add Users</a>
        <a th:href="@{/dashboard}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Dashboard</a>
        <a th:href="@{/settings}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Settings</a>
        <a th:href="@{/logout}" class="block py-2 px-3 rounded-lg bg-[var(--color-container-hover)] text-[var(--color-text)] font-semibold hover:bg-[var(--color-primary-dark)]">Logout</a>
    </div>
</nav>

<!-- Content Wrapper -->
<div class="content px-4 py-8 max-w-[75rem] mx-auto">

    <h1 class="text-center text-3xl font-bold mb-6" th:text="'Kalender - ' + ${monthName} + ' ' + ${year}">Calendar</h1>

    <!-- Year Navigation -->
    <form method="get" th:action="@{/calendar}" class="flex justify-center items-center gap-4 mb-8">
        <input type="hidden" name="month" th:value="${month}" />
        <button type="submit" name="year" th:value="${year - 1}" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded-lg hover:bg-[var(--color-primary-hover)] transition">&laquo; Previous year</button>
        <span class="text-lg font-semibold" th:text="${year}"></span>
        <button type="submit" name="year" th:value="${year + 1}" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded-lg hover:bg-[var(--color-primary-hover)] transition">Next year &raquo;</button>
    </form>

    <!-- Calendar Table -->
    <div class="calendar-wrapper overflow-x-auto flex justify-center">
        <table class="calendar-table w-full min-w-[43.75rem] bg-[rgba(255,255,255,0.05)] rounded-xl border-separate border-spacing-1">
            <thead>
            <tr>
                <th class="bg-[rgba(255,255,255,0.1)] text-[var(--color-text-muted)] py-1">Mo</th>
                <th class="bg-[rgba(255,255,255,0.1)] text-[var(--color-text-muted)] py-1">Tu</th>
                <th class="bg-[rgba(255,255,255,0.1)] text-[var(--color-text-muted)] py-1">We</th>
                <th class="bg-[rgba(255,255,255,0.1)] text-[var(--color-text-muted)] py-1">Th</th>
                <th class="bg-[rgba(255,255,255,0.1)] text-[var(--color-text-muted)] py-1">Fr</th>
                <th class="bg-[rgba(255,255,255,0.1)] text-[var(--color-text-muted)] py-1">Sa</th>
                <th class="bg-[rgba(255,255,255,0.1)] text-[var(--color-text-muted)] py-1">Su</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="week : ${weeks}">
                <td th:each="day : ${week}" th:classappend="${day.today} ? 'bg-[rgba(178,89,255,0.3)] border-[var(--color-primary)]' : '' + (${day.isCurrentMonth} ? '' : 'opacity-40')"
                    th:attr="data-date=${day.date}"
                    onclick="openCreateModal(this)"
                    class="w-32 h-32 p-2 rounded-lg align-top relative cursor-pointer">
                    <div class="day-number font-bold text-lg mb-1" th:text="${day.dayOfMonth}">1</div>
                    <div th:each="entry : ${day.entries}" class="entry p-1 rounded-md text-sm mb-1 bg-gradient-to-r from-[#3a3a4d] to-[#4d4d60] text-white shadow-sm cursor-default"
                         th:text="${entry.title}" th:attr="data-id=${entry.id}" onclick="event.stopPropagation(); openViewModal(this)">
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Month Switcher -->
    <div class="month-switcher text-center mt-8">
        <form method="get" th:action="@{/calendar}">
            <input type="hidden" name="year" th:value="${year}" />
            <div class="month-buttons inline-flex flex-wrap justify-center gap-2">
                <button type="submit" name="month" th:each="i : ${#numbers.sequence(1,12)}"
                        th:value="${i}" th:classappend="${month == i} ? 'bg-[var(--color-primary)] text-white' : 'bg-[#444] text-white'"
                        class="px-2 py-1 rounded-md font-bold hover:bg-[var(--color-primary-hover)] transition">
                    <span th:text="${i}">1</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modals -->
<div id="createModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-[rgba(15,15,30,0.9)]">
    <div class="modal-content bg-[var(--color-bg-alt)] rounded-xl shadow-lg p-6 flex flex-col gap-4 w-[90vw] max-w-md animate-fadeIn">
        <h2 class="text-2xl font-bold text-[var(--color-primary)] text-center mb-2">New Entry</h2>
        <form id="createEntryForm" method="post" th:action="@{/calendar/add}" class="flex flex-col gap-3">
            <input type="hidden" name="date" id="entryDate">
            <input type="text" name="title" placeholder="Title" required class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none"/>
            <textarea name="description" placeholder="Description" rows="4" required class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none"></textarea>
            <input type="time" name="entry_time" required class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none"/>
            <select name="visibility" required class="px-3 py-2 rounded-md bg-[var(--color-input)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none">
                <option value="PRIVATE">Private</option>
                <option value="PUBLIC">Public</option>
            </select>
            <div class="form-actions flex flex-wrap gap-2 mt-2">
                <button type="submit" class="flex-1 py-2 bg-[var(--color-primary)] text-white rounded-lg hover:bg-[var(--color-primary-hover)] transition">Save</button>
                <button type="button" onclick="closeModal('createModal')" class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Close</button>
            </div>
        </form>
    </div>
</div>

<div id="viewModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-[rgba(15,15,30,0.9)]"></div>


<!-- Scripts -->
<script>
    function openCreateModal(cell) {
      const date = cell.getAttribute("data-date");
      document.getElementById("entryDate").value = date;
      document.getElementById("createModal").classList.remove("hidden");
    }

    function openViewModal(entryElement) {
      const entryId = entryElement.getAttribute("data-id");
      fetch(`/springcloud/calendar/entry/view/${entryId}`)
        .then(res => res.text())
        .then(html => {
          const container = document.getElementById("viewModal");
          container.innerHTML = html;
          container.classList.remove("hidden");
        });
    }

    function closeModal(id) {
      document.getElementById(id).classList.add("hidden");
    }

    const burger = document.getElementById('burger');
    const mobileMenu = document.getElementById('mobileMenu');
    burger.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
      mobileMenu.classList.toggle('flex');
    });
</script>

<!-- Tailwind Animations -->
<style>
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(1.25rem); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
</style>
